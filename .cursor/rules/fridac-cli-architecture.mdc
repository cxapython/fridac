---
description: fridac CLI工具架构设计和代码组织规范
---

# fridac CLI 架构设计规范

## 项目结构

### 核心文件组织
- **[fridac](mdc:fridac)** - 主程序文件，Python CLI工具
- **[frida_common.js](mdc:frida_common.js)** - Java Hook工具集
- **[frida_native_common.js](mdc:frida_native_common.js)** - Native Hook工具集
- **[frida_location_hooks.js](mdc:frida_location_hooks.js)** - 定位Hook工具集

### 脚本加载顺序
1. 首先加载 `frida_common.js`（基础Java Hook）
2. 然后加载 `frida_native_common.js`（Native Hook扩展）
3. 最后加载 `frida_location_hooks.js`（定位Hook扩展）
4. 最终添加交互式Shell功能

## Python CLI 设计原则

### 命令行参数处理
```python
# 标准用法模式
fridac                                  # 自动连接前台应用
fridac -a                              # 显示应用列表选择
fridac -f com.example.app              # 生成模式
fridac -p com.example.app              # 附加模式
```

### 环境检测和兼容性
- 自动检测 Python 版本和 Frida 版本匹配
- 支持 pyenv 环境检测
- Rich 库优雅降级处理

### 错误处理标准
```python
def log_error(message, **kwargs):
    if RICH_AVAILABLE:
        timestamp = datetime.now().strftime("%H:%M:%S")
        console.print(f"[dim]{timestamp}[/dim] [red]❌[/red] {message}", **kwargs)
    else:
        print(f"❌ {message}")
```

## JavaScript 集成规范

### RPC 导出模式
```python
# 在 fridac 中的 JavaScript 模板
js_content += '''
rpc.exports = {
    // 直接导出核心函数
    smartTrace: smartTrace,
    loadNativeSupport: loadNativeSupport,
    
    // 条件导出可选函数
    hookBase64: typeof hookBase64 !== 'undefined' ? hookBase64 : function() { 
        console.log("hookBase64 需要定位Hook工具"); 
    }
};
'''
```

### 脚本路径查找策略
1. 当前文件目录
2. 用户主目录的 fridaproject 文件夹
3. 当前工作目录
4. 相对路径回退

## 交互式Shell设计

### 自动补全系统
- Tab 补全函数名
- 智能包名建议
- 常见Android类名模式匹配

### 命令历史管理
- 使用 `~/.fridac_history` 存储历史
- 支持跨会话历史记录
- 最大1000条历史记录

### 用户体验增强
- Rich 表格显示可用函数
- 彩色日志输出
- 进度指示器
- 优雅的错误提示

## 性能和安全考虑

### 连接管理
- 自动设备检测
- 优雅的断开连接处理
- 信号处理（Ctrl+C）

### 内存管理
- Frida 脚本的正确卸载
- 进程分离的清理工作
- 避免内存泄漏

### 兼容性保证
- Python 3.6.8+ 支持
- f-string 语法可用性确认
- Rich 库可选依赖处理