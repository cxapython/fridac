---
description: fridacli Hookå‡½æ•°å¼€å‘æ¨¡å¼å’Œæœ€ä½³å®è·µ
---

# fridacli Hookå‡½æ•°å¼€å‘æ¨¡å¼

## Hookå‡½æ•°æ ‡å‡†æ¨¡æ¿

### åŸºç¡€æ¨¡æ¿
æ‰€æœ‰Hookå‡½æ•°éƒ½åº”éµå¾ªä»¥ä¸‹æ ‡å‡†æ¨¡æ¿ï¼š

```javascript
function hookFunctionName(showStack, ...otherArgs) {
    showStack = showStack || 0;
    var needStack = showStack === 1;
    
    // è‡ªåŠ¨æ³¨å†Œä»»åŠ¡
    var taskId = null;
    if (typeof HookJobManager !== 'undefined') {
        taskId = HookJobManager.autoRegisterHook('hookFunctionName', [showStack, ...otherArgs]);
    }
    
    try {
        // Hookå®ç°é€»è¾‘
        var hookTarget = Java.use("target.class.name");
        
        hookTarget.methodName.implementation = function() {
            LOG("ğŸ¯ Hookè§¦å‘", { c: Color.Cyan });
            
            // æ›´æ–°ä»»åŠ¡å‘½ä¸­ç»Ÿè®¡
            if (taskId && typeof HookJobManager !== 'undefined') {
                HookJobManager.updateAutoTaskHit(taskId, { executionTime: 1 });
            }
            
            if (needStack) {
                printStackTrace();
            }
            
            return this.methodName.apply(this, arguments);
        };
        
        LOG("âœ… Hookå·²å¯ç”¨" + (taskId ? " (ä»»åŠ¡ID: #" + taskId + ")" : ""), { c: Color.Green });
        return taskId;
    } catch (e) {
        LOG("âŒ Hookå¤±è´¥: " + e.message, { c: Color.Red });
        
        // æ ‡è®°ä»»åŠ¡å¤±è´¥
        if (taskId && typeof HookJobManager !== 'undefined') {
            var job = HookJobManager.getJob(taskId);
            if (job) {
                job.updateStatus('failed', e);
            }
        }
        return null;
    }
}
```

## å‡½æ•°å‘½åè§„èŒƒ

### åˆ†ç±»å‰ç¼€
- **Java Hook**: æ— å‰ç¼€ï¼Œå¦‚ `traceClass`, `traceMethod`
- **Native Hook**: `native` å‰ç¼€ï¼Œå¦‚ `nativeHookNativeFunction`
- **å®šä½Hook**: `hook` å‰ç¼€ï¼Œå¦‚ `hookBase64`, `hookToast`
- **é«˜çº§åŠŸèƒ½**: æè¿°æ€§åç§°ï¼Œå¦‚ `smartTrace`, `advancedMethodTracing`

### å‚æ•°è§„èŒƒ
- **showStack**: ç»Ÿä¸€ä½¿ç”¨ `1`(æ˜¾ç¤ºè°ƒç”¨æ ˆ) æˆ– `0`(ä¸æ˜¾ç¤º)
- **target**: ç›®æ ‡ç±»åã€æ–¹æ³•åæˆ–æ¨¡å—å
- **options**: å¯¹è±¡ç±»å‹çš„é…ç½®å‚æ•°

## å·²å®ç°çš„Hookå‡½æ•°æ¨¡å¼

### å®šä½Hookå‡½æ•°
å‚è€ƒ [frida_location_hooks.js](mdc:frida_location_hooks.js) ä¸­çš„å®ç°ï¼š

- âœ… `hookLog()` - å·²é›†æˆè‡ªåŠ¨ä»»åŠ¡è¿½è¸ª
- âœ… `hookBase64()` - å·²é›†æˆè‡ªåŠ¨ä»»åŠ¡è¿½è¸ª  
- âœ… `hookToast()` - å·²é›†æˆè‡ªåŠ¨ä»»åŠ¡è¿½è¸ª
- ğŸ”§ å…¶ä»–å‡½æ•°é€šè¿‡åŒ…è£…å™¨è‡ªåŠ¨è·å¾—ä»»åŠ¡ç®¡ç†

### Java Hookå‡½æ•°
å‚è€ƒ [frida_common.js](mdc:frida_common.js) ä¸­çš„å®ç°ï¼š

- âœ… `hookAllMethodsInJavaClass()` / `traceClass()` - å·²é›†æˆä»»åŠ¡ç®¡ç†
- ğŸ”§ å…¶ä»–å‡½æ•°é€šè¿‡åŒ…è£…å™¨è‡ªåŠ¨è·å¾—ä»»åŠ¡ç®¡ç†

## è¾“å‡ºè§„èŒƒ

### æ—¥å¿—é¢œè‰²ç¼–ç 
```javascript
// æˆåŠŸä¿¡æ¯
LOG("âœ… Hookå·²å¯ç”¨", { c: Color.Green });

// é”™è¯¯ä¿¡æ¯  
LOG("âŒ Hookå¤±è´¥", { c: Color.Red });

// Hookè§¦å‘
LOG("ğŸ¯ æ–¹æ³•è¢«è°ƒç”¨", { c: Color.Cyan });

// å‚æ•°ä¿¡æ¯
LOG("  å‚æ•°: " + value, { c: Color.Yellow });

// è¿”å›å€¼
LOG("  è¿”å›: " + result, { c: Color.Blue });

// è°ƒç”¨æ ˆ
LOG("ğŸ“š è°ƒç”¨æ ˆ:", { c: Color.White });
```

### ä»»åŠ¡IDæ˜¾ç¤º
æˆåŠŸåˆ›å»ºHookæ—¶å¿…é¡»æ˜¾ç¤ºä»»åŠ¡IDï¼š
```javascript
LOG("âœ… Hookå·²å¯ç”¨ (ä»»åŠ¡ID: #" + taskId + ")", { c: Color.Green });
```

## ClassLoaderå¤„ç†

### æ ‡å‡†æ¨¡å¼
```javascript
var targetClass = null;
try {
    targetClass = Java.use(className);
} catch (error) {
    if(error.message.includes("ClassNotFoundException")){
        LOG("âŒ ç±»æœªåœ¨é»˜è®¤ClassLoaderä¸­æ‰¾åˆ°ï¼Œæœç´¢å…¶ä»–ClassLoader...", { c: Color.Yellow });
        var foundLoader = findTargetClassLoaderForClass(className);
        if (foundLoader) {
            targetClass = Java.ClassFactory.get(foundLoader).use(className);
            LOG("ğŸ¯ æˆåŠŸä½¿ç”¨è‡ªå®šä¹‰ClassLoaderåŠ è½½ç±»", { c: Color.Green });
        } else {
            LOG("âŒ åœ¨æ‰€æœ‰ClassLoaderä¸­éƒ½æœªæ‰¾åˆ°ç±»: " + className, { c: Color.Red });
            return null;
        }
    } else {
        LOG("âŒ åŠ è½½ç±»æ—¶å‘ç”Ÿå…¶ä»–é”™è¯¯: " + error.message, { c: Color.Red });
        return null;
    }
}
```

## é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

### ä»»åŠ¡çŠ¶æ€æ›´æ–°
```javascript
catch (e) {
    LOG("âŒ Hookå¤±è´¥: " + e.message, { c: Color.Red });
    
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
    if (taskId && typeof HookJobManager !== 'undefined') {
        var job = HookJobManager.getJob(taskId);
        if (job) {
            job.updateStatus('failed', e);
        }
    }
    
    return null; // æˆ–æŠ›å‡ºå¼‚å¸¸
}
```

### æ¸è¿›å¼é”™è¯¯å¤„ç†
1. **æ•è·å…·ä½“å¼‚å¸¸** - ClassNotFoundException, SecurityExceptionç­‰
2. **æä¾›æœ‰ç”¨ä¿¡æ¯** - å»ºè®®ç”¨æˆ·å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ
3. **ä¼˜é›…é™çº§** - éƒ¨åˆ†åŠŸèƒ½å¤±è´¥æ—¶ä¸å½±å“æ•´ä½“
4. **ä»»åŠ¡çŠ¶æ€ä¸€è‡´** - ç¡®ä¿ä»»åŠ¡ç®¡ç†å™¨çŠ¶æ€æ­£ç¡®

## æ€§èƒ½ä¼˜åŒ–

### Hookç‚¹é€‰æ‹©
- é€‰æ‹©å…³é”®è·¯å¾„ä¸Šçš„æ–¹æ³•
- é¿å…è¿‡äºé¢‘ç¹çš„æ–¹æ³•ï¼ˆå¦‚getter/setterï¼‰
- ä¼˜å…ˆHook publicæ–¹æ³•

### å†…å­˜ç®¡ç†
- åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„å¼•ç”¨
- ä½¿ç”¨ `Java.retain()` ä¿æŒå¿…è¦çš„å¯¹è±¡
- å®šæœŸè°ƒç”¨ `cleanup()` æ¸…ç†ä»»åŠ¡

### æ‰¹é‡æ“ä½œ
- ä½¿ç”¨ `batchHookWithFilters()` è¿›è¡Œæ‰¹é‡Hook
- åˆ©ç”¨ `killall()` æ‰¹é‡å–æ¶ˆä»»åŠ¡
- åˆç†ä½¿ç”¨ `pause()` æš‚åœå™ªéŸ³è¿‡å¤§çš„Hook