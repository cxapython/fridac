---
description: Frida JavaScript Hookå¼€å‘è§„èŒƒå’Œå¸¸è§æ¨¡å¼
globs: *.js
---

# Frida JavaScript Hook å¼€å‘è§„èŒƒ

## æ ¸å¿ƒåŸåˆ™

### ClassLoader å¤„ç†æ¨¡å¼
æ‰€æœ‰ Java ç±» Hook å¿…é¡»è€ƒè™‘åŠ¨æ€ ClassLoader é—®é¢˜ï¼š

```javascript
function hookJavaClass(className) {
    var hook = null;
    try {
        hook = Java.use(className);
    } catch (error) {
        if(error.message.includes("ClassNotFoundException")){
            LOG("âŒ ç±»æœªåœ¨é»˜è®¤ClassLoaderä¸­æ‰¾åˆ°ï¼Œæœç´¢å…¶ä»–ClassLoader...", { c: Color.Yellow });
            var foundLoader = findTragetClassLoader(className);
            if (foundLoader) {
                hook = Java.ClassFactory.get(foundLoader).use(className);
                LOG("ğŸ¯ æˆåŠŸä½¿ç”¨è‡ªå®šä¹‰ClassLoaderåŠ è½½ç±»", { c: Color.Green });
            } else {
                LOG("âŒ åœ¨æ‰€æœ‰ClassLoaderä¸­éƒ½æœªæ‰¾åˆ°ç±»: " + className, { c: Color.Red });
                return null;
            }
        } else {
            LOG("âŒ åŠ è½½ç±»æ—¶å‘ç”Ÿå…¶ä»–é”™è¯¯: " + error.message, { c: Color.Red });
            return null;
        }
    }
    return hook;
}
```

### è¾“å‡ºå’Œé”™è¯¯å¤„ç†è§„èŒƒ
- **ç»Ÿä¸€è¾“å‡º**ï¼šæ‰€æœ‰è¾“å‡ºå¿…é¡»ä½¿ç”¨ `LOG()` å‡½æ•°ï¼Œç¦æ­¢ä½¿ç”¨ `console.log()`
- **é¢œè‰²ç¼–ç **ï¼šRed(é”™è¯¯)ã€Yellow(è­¦å‘Š)ã€Green(æˆåŠŸ)ã€Cyan(ä¿¡æ¯)ã€Blue(è¿”å›å€¼)ã€White(å‚æ•°/å †æ ˆ)
- **emojiæ ‡è¯†**ï¼šğŸ¯(è¿›å…¥)ã€ğŸ“¥(å‚æ•°)ã€ğŸ“¤(è¿”å›å€¼)ã€ğŸ(é€€å‡º)ã€ğŸ“š(å †æ ˆ)ã€ğŸ“(è°ƒç”¨ä½ç½®)
- **æ ¼å¼åŒ–è¾“å‡º**ï¼šå‚æ•°å’Œè¿”å›å€¼æŒ‰ç±»å‹æ ¼å¼åŒ–ï¼Œé•¿å­—ç¬¦ä¸²è‡ªåŠ¨æˆªæ–­

### å‡½æ•°å‘½åè§„èŒƒ
- Java Hook å‡½æ•°ï¼šç›´æ¥ä½¿ç”¨å‡½æ•°åï¼Œå¦‚ `traceClass`, `traceMethod`
- Native Hook å‡½æ•°ï¼šä½¿ç”¨ `native` å‰ç¼€ï¼Œå¦‚ `nativeHookNativeFunction`
- å®šä½ Hook å‡½æ•°ï¼šä½¿ç”¨ `hook` å‰ç¼€ï¼Œå¦‚ `hookBase64`, `hookToast`

### RPC å¯¼å‡ºè§„èŒƒ
- æ ¸å¿ƒå‡½æ•°ç›´æ¥å¯¼å‡ºï¼š`funcName: funcName`
- å¯é€‰å‡½æ•°ä½¿ç”¨æ¡ä»¶å¯¼å‡ºï¼š`funcName: typeof funcName !== 'undefined' ? funcName : fallbackFunction`
- ç¡®ä¿ `smartTrace`, `loadNativeSupport`, `findStrInMap` ç­‰å…³é”®å‡½æ•°ç›´æ¥å¯¼å‡º

## Hook å®ç°æ¨¡å¼

### æ–¹æ³• Hook æ ‡å‡†æ¨¡æ¿
```javascript
hook[methodName].implementation = function() {
    LOG("\n*** entered " + fullMethodName);
    
    if(showTrace) {
        printStack();
    }
    
    // æ‰“å°å‚æ•°
    if (arguments.length) console.log();
    for (var j = 0; j < arguments.length; j++) {
        console.log("arg[" + j + "]: " + arguments[j]);
    }
    
    // è°ƒç”¨åŸæ–¹æ³•
    var retval = this[methodName].apply(this, arguments);
    
    // æ‰“å°è¿”å›å€¼
    console.log("\nReturn Value: " + retval);
    LOG("\n*** exiting " + fullMethodName);
    return retval;
}
```

### ClassLoader ä¿¡æ¯è·å–
å¿…é¡»æä¾›è¯¦ç»†çš„ ClassLoader ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- ClassLoader ç±»å‹
- æ–‡ä»¶è·¯å¾„ï¼ˆAPKã€DEXã€JARï¼‰
- çˆ¶ ClassLoader ä¿¡æ¯

## å †æ ˆä¿¡æ¯ä¼˜åŒ–

### printStack å‡½æ•°æ ‡å‡†
```javascript
var printStack = function () {
    // 1. è·å–å®Œæ•´å †æ ˆ
    // 2. è¿‡æ»¤æ— ç”¨ä¿¡æ¯ï¼ˆExceptionã€Logã€dalvik.systemç­‰ï¼‰
    // 3. ç®€åŒ–ç±»åæ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºæœ€åä¸¤ä¸ªåŒ…å±‚çº§ï¼‰
    // 4. é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼ˆæœ€å¤š8ä¸ªæœ‰æ•ˆè°ƒç”¨ï¼‰
    // 5. ç¾åŒ–è¾“å‡ºæ ¼å¼ï¼šğŸ“š è°ƒç”¨å †æ ˆ + ğŸ“ ä½ç½®ä¿¡æ¯
}
```

### è¾“å‡ºæ ¼å¼è§„èŒƒ
- **ç®€åŒ–è·¯å¾„**ï¼š`...MainBridge.main` è€Œä¸æ˜¯å®Œæ•´åŒ…å
- **ç²¾ç¡®ä½ç½®**ï¼š`(MainBridge.java:45)` æ˜¾ç¤ºæ–‡ä»¶åå’Œè¡Œå·
- **è¿‡æ»¤ç­–ç•¥**ï¼šè·³è¿‡ç³»ç»Ÿå†…éƒ¨è°ƒç”¨ï¼Œåªæ˜¾ç¤ºåº”ç”¨ç›¸å…³ä»£ç 
- **æ•°é‡é™åˆ¶**ï¼šæœ€å¤šæ˜¾ç¤º8ä¸ªå…³é”®è°ƒç”¨ï¼Œé¿å…ä¿¡æ¯è¿‡è½½

## æœ€ä½³å®è·µ

1. **ç»Ÿä¸€è¾“å‡º**ï¼šç¦æ­¢ä½¿ç”¨ `console.log()`ï¼Œå¿…é¡»ä½¿ç”¨ `LOG()` å‡½æ•°
2. **æ™ºèƒ½è¯†åˆ«é€»è¾‘**ï¼š`smartTrace` å‡½æ•°åº”ä¼˜å…ˆè¯†åˆ«ä¸ºç±»ï¼Œé™¤éæ˜ç¡®æ˜¯å¸¸è§æ–¹æ³•å
3. **è·¯å¾„ä¿¡æ¯**ï¼šæ‰€æœ‰åŠ¨æ€åŠ è½½çš„ç±»éƒ½è¦æ˜¾ç¤ºæ–‡ä»¶æ¥æºè·¯å¾„
4. **å †æ ˆä¼˜åŒ–**ï¼šä½¿ç”¨ç®€åŒ–çš„å †æ ˆä¿¡æ¯ï¼Œçªå‡ºå…³é”®è°ƒç”¨é“¾
5. **å‘ä¸‹å…¼å®¹**ï¼šä¿æŒå¯¹æ—§ç‰ˆæœ¬ Android å’Œ Frida çš„å…¼å®¹æ€§
6. **æ€§èƒ½è€ƒè™‘**ï¼šä½¿ç”¨ `Java.enumerateClassLoadersSync()` è€Œä¸æ˜¯å¼‚æ­¥ç‰ˆæœ¬
7. **å†…å­˜ç®¡ç†**ï¼šä½¿ç”¨ `Java.retain()` ä¿æŒ ClassLoader å¼•ç”¨