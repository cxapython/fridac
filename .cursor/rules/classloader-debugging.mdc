---
description: ClassLoaderè°ƒè¯•å’Œè·¯å¾„ä¿¡æ¯è·å–æœ€ä½³å®è·µ
---

# ClassLoader è°ƒè¯•å’Œè·¯å¾„ä¿¡æ¯è·å–

## æ ¸å¿ƒåŠŸèƒ½

### findTragetClassLoader å¢å¼ºåŠŸèƒ½
[frida_common.js](mdc:frida_common.js) ä¸­çš„ `findTragetClassLoader` å‡½æ•°ç°åœ¨æä¾›ï¼š

1. **è¯¦ç»†çš„ClassLoaderç±»å‹ä¿¡æ¯**
2. **å…·ä½“çš„æ–‡ä»¶è·¯å¾„åˆ—è¡¨**  
3. **çˆ¶ClassLoaderç»§æ‰¿å…³ç³»**
4. **å‹å¥½çš„è°ƒè¯•è¾“å‡º**

## å®ç°æŠ€æœ¯

### è·¯å¾„ä¿¡æ¯è·å–ç­–ç•¥
```javascript
function getClassLoaderInfo(loader) {
    // 1. åå°„è·å–pathListå­—æ®µ
    var pathListField = loader.getClass().getDeclaredField("pathList");
    pathListField.setAccessible(true);
    var pathList = pathListField.get(loader);
    
    // 2. è·å–dexElementsæ•°ç»„
    var dexElementsField = pathList.getClass().getDeclaredField("dexElements");
    dexElementsField.setAccessible(true);
    var dexElements = dexElementsField.get(pathList);
    
    // 3. éå†æ¯ä¸ªelementè·å–path
    for (var i = 0; i < dexElements.length; i++) {
        var pathField = element.getClass().getDeclaredField("path");
        pathField.setAccessible(true);
        var path = pathField.get(element);
        // æ”¶é›†è·¯å¾„ä¿¡æ¯
    }
}
```

### å…¼å®¹æ€§å¤„ç†
- æ”¯æŒä¸åŒAndroidç‰ˆæœ¬çš„å­—æ®µåå˜åŒ–
- ä¼˜é›…å¤„ç†åå°„å¤±è´¥çš„æƒ…å†µ
- æä¾›toString()å›é€€æ–¹æ¡ˆ

## è°ƒè¯•è¾“å‡ºæ ¼å¼

### æ ‡å‡†è¾“å‡ºæ¨¡æ¿
```
âœ… æ‰¾åˆ°ç›®æ ‡ç±» 'com.example.Class' åœ¨ClassLoader: dalvik.system.DexClassLoader@12345678
ğŸ“ ClassLoaderç±»å‹: dalvik.system.DexClassLoader
ğŸ“‚ æ–‡ä»¶è·¯å¾„:
   [1] /data/app/com.example.app/base.apk
   [2] /data/app/com.example.app/split_config.arm64_v8a.apk
   [3] /system/framework/framework.jar
ğŸ”— çˆ¶ClassLoader: dalvik.system.PathClassLoader
```

### é¢œè‰²ç¼–ç è§„èŒƒ
- ğŸŸ¢ Green: æˆåŠŸæ‰¾åˆ°ç±»/ClassLoader
- ğŸ”µ Cyan: ClassLoaderç±»å‹ä¿¡æ¯
- ğŸŸ¡ Yellow: æ–‡ä»¶è·¯å¾„æ ‡é¢˜
- âšª White: å…·ä½“è·¯å¾„åˆ—è¡¨
- ğŸ”µ Blue: çˆ¶ClassLoaderä¿¡æ¯
- ğŸ”´ Red: é”™è¯¯ä¿¡æ¯

## å¸¸è§ClassLoaderç±»å‹

### 1. DexClassLoader
- **ç”¨é€”**: åŠ¨æ€åŠ è½½å¤–éƒ¨DEX/APKæ–‡ä»¶
- **è·¯å¾„ç‰¹å¾**: `/data/app/`, `/sdcard/`, è‡ªå®šä¹‰è·¯å¾„
- **å¸¸è§åœºæ™¯**: æ’ä»¶åŒ–ã€çƒ­ä¿®å¤ã€ç¬¬ä¸‰æ–¹åº“

### 2. PathClassLoader  
- **ç”¨é€”**: åŠ è½½åº”ç”¨ä¸»APKå’Œç³»ç»Ÿç±»
- **è·¯å¾„ç‰¹å¾**: `/data/app/packagename/`, `/system/framework/`
- **å¸¸è§åœºæ™¯**: åº”ç”¨ä¸»è¦ä»£ç ã€Androidç³»ç»Ÿç±»

### 3. InMemoryDexClassLoader
- **ç”¨é€”**: ä»å†…å­˜ä¸­çš„å­—èŠ‚æ•°ç»„åŠ è½½
- **è·¯å¾„ç‰¹å¾**: é€šå¸¸æ²¡æœ‰æ–‡ä»¶è·¯å¾„
- **å¸¸è§åœºæ™¯**: åŠ¨æ€ç”Ÿæˆçš„ä»£ç ã€åè°ƒè¯•æŠ€æœ¯

### 4. BootClassLoader
- **ç”¨é€”**: åŠ è½½æ ¸å¿ƒJavaç±»
- **è·¯å¾„ç‰¹å¾**: `/system/framework/core.jar`
- **å¸¸è§åœºæ™¯**: Javaæ ‡å‡†åº“ã€Androidæ¡†æ¶

## å®‰å…¨åˆ†æåº”ç”¨

### 1. æ’ä»¶åŒ–æ£€æµ‹
é€šè¿‡è·¯å¾„ä¿¡æ¯å¯ä»¥è¯†åˆ«ï¼š
- ä¸»APK vs æ’ä»¶APK
- å®˜æ–¹æ’ä»¶ vs ç¬¬ä¸‰æ–¹æ’ä»¶
- æ’ä»¶çš„åŠ è½½æ¥æº

### 2. çƒ­ä¿®å¤åˆ†æ
- ä¿®å¤åŒ…çš„æ–‡ä»¶è·¯å¾„
- ä¿®å¤åŒ…çš„åŠ è½½é¡ºåº
- åŸå§‹ä»£ç  vs ä¿®å¤ä»£ç 

### 3. åŠ å›ºåˆ†æ
- åŠ å›ºå£³çš„ClassLoader
- åŸå§‹ä»£ç çš„è§£å¯†ä½ç½®
- å¤šå±‚ClassLoaderç»“æ„

## è°ƒè¯•æŠ€å·§

### 1. ClassLoaderå±‚æ¬¡ç»“æ„åˆ†æ
```javascript
function analyzeClassLoaderHierarchy(loader) {
    var current = loader;
    var level = 0;
    while (current) {
        LOG("  ".repeat(level) + "â””â”€ " + current.getClass().getName(), { c: Color.Cyan });
        current = current.getParent();
        level++;
    }
}
```

### 2. æ‰¹é‡ç±»æŸ¥æ‰¾
```javascript
function findClassInAllLoaders(className) {
    var loaderList = Java.enumerateClassLoadersSync();
    var foundLoaders = [];
    loaderList.forEach(function(loader) {
        try {
            var cls = loader.findClass(className);
            if (cls) foundLoaders.push(loader);
        } catch (e) {}
    });
    return foundLoaders;
}
```

### 3. è·¯å¾„æ¨¡å¼åˆ†æ
- APKåˆ†åŒ…ï¼š`split_*.apk`
- ç³»ç»Ÿæ¡†æ¶ï¼š`/system/framework/`
- ç”¨æˆ·åº”ç”¨ï¼š`/data/app/`
- å¤–éƒ¨å­˜å‚¨ï¼š`/sdcard/`