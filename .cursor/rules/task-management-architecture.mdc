---
description: fridacli任务管理系统核心架构和扩展指南
---

# fridacli 任务管理系统架构

## 核心组件架构

### 主要文件和职责
- **[frida_job_manager.js](mdc:frida_job_manager.js)** - 任务管理器核心，包含 `HookJobManager` 和 `HookJob` 类
- **[frida_job_commands.js](mdc:frida_job_commands.js)** - 用户命令接口，提供 `jobs()`, `kill()` 等函数
- **[fridac](mdc:fridac)** - 主程序，集成任务管理系统并提供 RPC 导出

### 类层次结构

#### HookJob 类
```javascript
function HookJob(type, target, options, hookFunction) {
    this.id = nextJobId++;           // 自动递增的任务ID
    this.type = type;                // 任务类型枚举
    this.target = target;            // Hook目标描述
    this.options = options;          // 配置选项
    this.status = JobStatus.PENDING; // 任务状态
    this.metadata = {                // 元数据
        hitCount: 0,                 // 命中次数
        lastHit: null,              // 最后命中时间
        errors: [],                 // 错误记录
        performance: {...}          // 性能统计
    };
}
```

#### HookJobManager 单例
```javascript
var HookJobManager = (function() {
    var nextJobId = 1;              // 全局任务ID计数器
    var activeJobs = new Map();     // 活跃任务映射
    var jobHistory = [];            // 任务历史记录
    
    return {
        // 核心方法
        autoRegisterHook: function(functionName, args),
        updateAutoTaskHit: function(jobId, hitInfo),
        getJob: function(jobId),
        
        // 任务控制
        cancelJob: function(jobId),
        pauseJob: function(jobId),
        resumeJob: function(jobId),
        
        // 查询和统计
        showJobs: function(statusFilter),
        getActiveJobs: function(),
        getStatistics: function()
    };
})();
```

## 任务状态管理

### 状态枚举
```javascript
var JobStatus = {
    PENDING: 'pending',     // 等待执行
    ACTIVE: 'active',       // 正在运行
    PAUSED: 'paused',       // 已暂停
    COMPLETED: 'completed', // 已完成
    FAILED: 'failed',       // 执行失败
    CANCELLED: 'cancelled'  // 已取消
};
```

### 状态转换规则
```
创建(pending) → 执行(active) → [暂停(paused)/恢复(active)] → 完成(completed)/取消(cancelled)/失败(failed)
```

### 任务类型分类
```javascript
var JobType = {
    METHOD_HOOK: 'method_hook',     // 方法Hook
    CLASS_HOOK: 'class_hook',       // 类Hook
    NATIVE_HOOK: 'native_hook',     // Native Hook
    LOCATION_HOOK: 'location_hook', // 定位Hook
    ADVANCED_HOOK: 'advanced_hook', // 高级Hook
    BATCH_HOOK: 'batch_hook',       // 批量Hook
    AUTO_HOOK: 'auto_hook'          // 自动追踪Hook
};
```

## 自动追踪机制

### 任务注册流程
1. **Hook函数调用** → 
2. **autoRegisterHook()** → 
3. **创建HookJob实例** → 
4. **分配递增ID** → 
5. **添加到activeJobs** → 
6. **返回taskId**

### 智能类型检测
```javascript
detectHookType: function(functionName) {
    if (functionName.toLowerCase().includes('native')) {
        return JobType.NATIVE_HOOK;
    } else if (functionName.toLowerCase().includes('class')) {
        return JobType.CLASS_HOOK;
    } else if (functionName.startsWith('hook')) {
        return JobType.LOCATION_HOOK;
    }
    // ... 更多检测逻辑
}
```

### 目标描述格式化
```javascript
formatHookTarget: function(functionName, args) {
    var target = functionName + "(";
    // 最多显示3个参数，长字符串截断
    // 返回格式: "hookBase64(1)" 或 "traceClass('com.example...')"
}
```

## 命令接口设计

### 基础命令
```javascript
// 查看类命令
jobs(statusFilter)    // 显示任务列表
job(jobId)           // 显示任务详情
jobstats()           // 显示统计信息
history(limit)       // 显示历史记录

// 控制类命令  
kill(jobId)          // 取消任务
killall(typeFilter)  // 批量取消
pause(jobId)         // 暂停任务
resume(jobId)        // 恢复任务

// 维护类命令
cleanup()            // 清理已完成任务
exportJobs()         // 导出配置
jobhelp()           // 显示帮助
```

### 快捷命令
```javascript
j()     // jobs() 快捷方式
k(id)   // kill(id) 快捷方式
ka()    // killall() 快捷方式
jh()    // jobhelp() 快捷方式
```

## RPC导出规范

### 主程序集成
在 [fridac](mdc:fridac) 的 RPC exports 中：

```javascript
rpc.exports = {
    // 任务管理命令
    jobs: typeof jobs !== 'undefined' ? jobs : fallbackFunction,
    job: typeof job !== 'undefined' ? job : fallbackFunction,
    kill: typeof kill !== 'undefined' ? kill : fallbackFunction,
    // ... 其他命令
    
    // Hook函数保持原有导出方式
    hookBase64: hookBase64,
    traceClass: traceClass,
    // ...
};
```

### 错误处理模式
```javascript
functionName: typeof functionName !== 'undefined' ? functionName : function() { 
    LOG("functionName 需要任务管理系统", { c: Color.Yellow }); 
}
```

## 扩展开发指南

### 添加新任务类型
1. 在 `JobType` 枚举中添加新类型
2. 在 `detectHookType()` 中添加检测逻辑
3. 在 `generateDescription()` 中添加描述逻辑
4. 创建对应的Hook函数模板

### 添加新管理命令
1. 在 [frida_job_commands.js](mdc:frida_job_commands.js) 中实现命令函数
2. 在 [fridac](mdc:fridac) 的 RPC exports 中导出
3. 在 `FridacCompleter.functions` 中添加自动补全支持
4. 更新 `jobhelp()` 函数的帮助信息

### 性能优化策略
1. **任务存储优化** - 使用Map而非Array提高查找效率
2. **内存管理** - 限制jobHistory大小，定期清理
3. **批量操作** - 支持按类型批量操作任务
4. **延迟加载** - 任务详情按需计算

### 监控和调试
```javascript
// 统计信息结构
{
    totalJobs: number,
    activeJobs: number,
    pausedJobs: number,
    completedJobs: number,
    failedJobs: number,
    totalHits: number,
    avgHitsPerJob: number,
    systemUptime: string,
    memoryUsage: string
}
```

## 向下兼容保证

### 原有函数保持不变
- 所有现有Hook函数调用方式不变
- 返回值可能变为taskId，但不影响boolean判断
- 错误处理机制保持一致

### 新功能可选使用
- 自动任务追踪是增强功能
- 可以忽略返回的taskId
- 手动任务管理（WithJob函数）仍然可用

### 渐进式升级
- 可以逐步为更多函数添加任务管理
- 不破坏现有代码的前提下增强功能
- 向前兼容新版本的扩展