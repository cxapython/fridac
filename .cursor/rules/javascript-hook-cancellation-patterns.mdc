---
description: JavaScript Hookå–æ¶ˆå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ
globs: *.js
---

# JavaScript Hook å–æ¶ˆå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

## Hookç±»å‹ä¸å–æ¶ˆæœºåˆ¶

### Java Hook (Frida Java API)
```javascript
// âŒ æ— æ³•å®Œå…¨å–æ¶ˆçš„æ¨¡å¼
Java.use("className").methodName.implementation = function() {
    // è¿™ç§Hookæ— æ³•é€šè¿‡detach()ç§»é™¤
};

// âœ… å¯ç®¡ç†çš„æ¨¡å¼
function hookWithTaskManagement() {
    var taskId = HookJobManager.autoRegisterHook('functionName', args);
    
    Java.use("className").methodName.implementation = function() {
        // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
        if (taskId && typeof HookJobManager !== 'undefined') {
            var job = HookJobManager.getJob(taskId);
            if (job && job.status !== 'cancelled') {
                // åªæœ‰æœªå–æ¶ˆçš„ä»»åŠ¡æ‰æ‰§è¡Œé€»è¾‘
                HookJobManager.updateAutoTaskHit(taskId, { executionTime: 1 });
                LOG("Hook triggered", { c: Color.Green });
            }
        }
        return this.methodName.apply(this, arguments);
    };
    
    return taskId;
}
```

### Native Hook (Frida Native API)
```javascript
// âœ… å¯å®Œå…¨å–æ¶ˆçš„æ¨¡å¼
function nativeHookWithCancellation() {
    var interceptor = Interceptor.attach(targetAddress, {
        onEnter: function(args) {
            // Hooké€»è¾‘
        }
    });
    
    // ä¿å­˜åˆ°ä»»åŠ¡çš„interceptorsæ•°ç»„
    job.interceptors.push(interceptor);
    
    // å¯é€šè¿‡interceptor.detach()å®Œå…¨ç§»é™¤
    return interceptor;
}
```

## ä»»åŠ¡å–æ¶ˆå®ç°æ¨¡å¼

### æ ‡å‡†å–æ¶ˆæµç¨‹
```javascript
HookJob.prototype.cancel = function() {
    try {
        // 1. è‡ªåŠ¨è¿½è¸ªä»»åŠ¡ç‰¹æ®Šå¤„ç†
        if (this.options.autoTracked) {
            LOG("âš ï¸  è‡ªåŠ¨è¿½è¸ªä»»åŠ¡å·²æ ‡è®°ä¸ºå–æ¶ˆ", { c: Color.Yellow });
            LOG("ğŸ’¡ æ³¨æ„: Java Hookæ— æ³•å®Œå…¨ç§»é™¤ï¼Œä½†ä¸ä¼šå†è®¡å…¥ç»Ÿè®¡", { c: Color.Blue });
            this.updateStatus(JobStatus.CANCELLED);
            return true;
        }
        
        // 2. Native Hookæ ‡å‡†å¤„ç†
        this.interceptors.forEach(function(interceptor) {
            if (interceptor && typeof interceptor.detach === 'function') {
                interceptor.detach();
            }
        });
        
        this.interceptors = [];
        this.updateStatus(JobStatus.CANCELLED);
        return true;
    } catch (error) {
        this.updateStatus(JobStatus.FAILED, error);
        return false;
    }
};
```

## çŠ¶æ€æ£€æŸ¥æ¨¡å¼

### Hookå‡½æ•°ä¸­çš„çŠ¶æ€æ£€æŸ¥
```javascript
// åœ¨Hookå®ç°ä¸­æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
if (taskId && typeof HookJobManager !== 'undefined') {
    var job = HookJobManager.getJob(taskId);
    if (job && job.status !== 'cancelled') {
        // åªæœ‰æ´»è·ƒä»»åŠ¡æ‰æ‰§è¡Œç»Ÿè®¡å’Œæ—¥å¿—
        HookJobManager.updateAutoTaskHit(taskId, { executionTime: 1 });
        LOG("Hookæ´»è·ƒ", { c: Color.Green });
    }
    // å·²å–æ¶ˆçš„ä»»åŠ¡é™é»˜æ‰§è¡Œï¼Œä¸äº§ç”Ÿè¾“å‡º
}
```

## ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### æ¸…æ™°çš„çŠ¶æ€åé¦ˆ
```javascript
function kill(jobId) {
    var job = HookJobManager.getJob(parseInt(jobId));
    if (job && job.options.autoTracked) {
        LOG("ğŸ¯ æ­£åœ¨å–æ¶ˆè‡ªåŠ¨è¿½è¸ªä»»åŠ¡ #" + jobId, { c: Color.Cyan });
    }
    return HookJobManager.killJob(parseInt(jobId));
}
```

### æŠ€æœ¯é™åˆ¶è¯´æ˜
- Java Hookæ— æ³•å®Œå…¨ç§»é™¤ï¼Œåªèƒ½çŠ¶æ€ç®¡ç†
- Native Hookå¯å®Œå…¨detach
- è‡ªåŠ¨è¿½è¸ªä»»åŠ¡é€šè¿‡çŠ¶æ€æ£€æŸ¥æ§åˆ¶è¡Œä¸º
- é‡å¯åº”ç”¨æ˜¯æœ€å½»åº•çš„Hookæ¸…ç†æ–¹æ³•