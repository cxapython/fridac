---
description: fridacli任务管理系统架构和开发规范
---

# fridacli 任务管理系统开发规范

## 核心架构

fridacli 的任务管理系统由以下核心组件组成：

- **[frida_job_manager.js](mdc:frida_job_manager.js)** - 任务管理器核心，包含 HookJobManager 和 HookJob 类
- **[frida_job_commands.js](mdc:frida_job_commands.js)** - 用户命令接口，提供 jobs()、kill() 等命令
- **[fridac](mdc:fridac)** - 主程序集成了任务管理系统的加载和 RPC 导出

## 任务管理设计原则

### 1. 任务状态管理
任务必须遵循以下状态转换：
```
创建(pending) → 执行(active) → [暂停(paused)/恢复(active)] → 完成(completed)/取消(cancelled)/失败(failed)
```

### 2. 任务类型分类
所有Hook任务必须归类为以下类型之一：
- `method_hook` - 方法Hook
- `class_hook` - 类Hook  
- `native_hook` - Native Hook
- `location_hook` - 定位Hook
- `advanced_hook` - 高级Hook
- `batch_hook` - 批量Hook

### 3. 错误处理规范
- 所有任务操作必须包含 try-catch 错误处理
- 错误信息必须记录到任务的 metadata.errors 数组
- 错误日志使用 LOG() 函数，颜色设置为 Color.Red

### 4. 性能监控要求
- 每个任务必须跟踪 hitCount（命中次数）
- 记录 lastHit（最后命中时间）
- 监控 avgTime（平均执行时间）

## 命令接口规范

### 1. 命令命名约定
- 查看类命令：jobs(), job(), jobstats(), history()
- 控制类命令：kill(), killall(), pause(), resume()
- 维护类命令：cleanup(), exportJobs()
- 帮助类命令：jobhelp()

### 2. 参数验证
所有命令函数必须：
- 检查任务管理器是否已初始化
- 验证必需参数是否提供
- 提供清晰的错误提示信息

### 3. 返回值规范
- 控制操作返回 boolean（成功/失败）
- 查询操作返回具体数据或显示信息
- 批量操作返回影响的项目数量

## 集成开发规范

### 1. RPC 导出规范
在 [fridac](mdc:fridac) 中添加新的任务管理函数时，必须：
- 在 RPC exports 对象中添加函数导出
- 提供 fallback 函数处理功能不可用的情况
- 使用统一的错误提示格式

### 2. 帮助信息规范
新增的任务管理命令必须：
- 在 help() 函数中添加说明
- 在 self.functions 字典中添加条目
- 提供使用示例

### 3. 向后兼容原则
- 原有Hook函数必须保持不变
- 新增功能通过 *WithJob 后缀函数提供
- 保持原有函数签名和行为

## 代码质量要求

### 1. 函数命名规范
- 使用有意义的变量名（如 `jobId` 而不是 `id`）
- 驼峰命名法（如 `createJob`, `executeJob`）
- 避免缩写，使用完整单词

### 2. 文档要求
- 所有公共函数必须有 JSDoc 注释
- 参数必须包含类型和说明
- 复杂逻辑必须有行内注释

### 3. 日志输出规范
- 使用 LOG() 函数而不是 console.log
- 根据消息类型选择适当的颜色
- 包含适当的 emoji 图标提升用户体验

## 扩展开发指南

### 1. 添加新任务类型
1. 在 JobType 枚举中添加新类型
2. 在 HookJob.generateDescription() 中添加描述逻辑
3. 创建对应的 *WithJob 包装函数
4. 更新文档和帮助信息

### 2. 添加新管理命令
1. 在 [frida_job_commands.js](mdc:frida_job_commands.js) 中实现命令函数
2. 在 [fridac](mdc:fridac) 的 RPC exports 中导出
3. 在 self.functions 中添加补全支持
4. 更新 jobhelp() 函数

### 3. 性能优化考虑
- 定期调用 cleanup() 清理完成的任务
- 限制 jobHistory 数组大小避免内存泄漏
- 使用 HookJobManager.getStatistics() 监控系统性能

## 测试和验证

### 1. 功能测试要点
- 任务创建和执行
- 状态转换正确性
- 错误处理机制
- 资源清理功能

### 2. 性能测试要求
- 大量任务创建和管理
- 长时间运行稳定性
- 内存使用监控
- Hook性能影响评估

## 故障排除指南

### 1. 常见问题
- 任务管理器未初始化：检查 JavaScript 加载顺序
- 命令不可用：检查 RPC 导出配置
- 任务无法取消：检查 Interceptor 对象存储

### 2. 调试技巧
- 使用 jobstats() 查看系统状态
- 使用 job(id) 查看具体任务详情
- 检查 metadata.errors 数组获取错误信息