#!/usr/bin/env python3
"""
fridac - 增强版 Frida CLI 工具，带交互式 JavaScript Shell（模块化版本）

用法:
  fridac                              # 智能模式自动附加到前台应用
  fridac -a                           # 显示应用列表供选择
  fridac -f com.example.app           # 以 Spawn 模式启动并附加（等同 frida -U -f com.example.app）
  fridac -p com.example.app           # 附加到指定包（等同 frida -U com.example.app）
  fridac --spawn com.example.app      # Spawn 模式（同 -f）

特性:
- 带自动补全的交互式 JavaScript Shell
- 自动设备检测与连接
- 智能包名处理
- 内置追踪与调试功能
- 自动任务追踪系统
- Rich UI 支持

自动检测 pyenv 的 Python 版本并选择对应的 Frida:
- Python 3.6.8 -> Frida 14.x
- Python 3.8.2 -> Frida 16.x
"""

import sys
import os
import argparse
import signal

# 将 fridac_core 包加入 Python 路径
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from fridac_core.logger import show_banner, log_info, log_success, log_error, log_warning
from fridac_core.environment import (
    detect_python_environment, 
    get_frida_version, 
    get_frontmost_app, 
    find_target_app,
    show_environment_info
)
from fridac_core.session import FridacSession, run_interactive_session

def run_frida_session(spawn_mode=False, target_package=None, force_show_apps=False):
    """运行 Frida 会话（带交互式 Shell）"""
    
    if force_show_apps or not target_package:
        # 交互式查找目标应用
        target_app = find_target_app()
        if not target_app:
            return
    else:
        # 使用指定的包名
        target_app = target_package
        log_info("使用指定的包名: {}".format(target_app))
    
    session = FridacSession()
    
    # 安装信号处理器以优雅退出
    def signal_handler(sig, frame):
        log_info("正在退出...")
        session.disconnect()
        sys.exit(0)
    
    signal.signal(signal.SIGINT, signal_handler)
    
    # 连接到应用
    if not session.connect_to_app(target_app, spawn_mode):
        return
    
    # 进入交互式会话
    run_interactive_session(session)
    
    # 清理
    session.disconnect()

def main():
    """主函数"""
    parser = argparse.ArgumentParser(
        description='fridac - Enhanced Frida CLI tool with interactive JavaScript shell',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  fridac                                    # Auto-attach to frontmost app (smart mode)
  fridac -a                                 # Show apps list for selection
  fridac -f com.example.app                 # Spawn app and attach
  fridac -p com.example.app                 # Attach to specific package
  fridac --spawn com.example.app            # Spawn app and attach (same as -f)
        '''
    )
    
    parser.add_argument('-f', '--package', type=str,
                       help='Specify package name to spawn and attach')
    
    parser.add_argument('-p', '--attach-package', type=str,
                       help='Specify package name to attach (without spawning)')
    
    parser.add_argument('-a', '--apps', action='store_true',
                       help='Show apps list for selection (original behavior)')
    
    parser.add_argument('--spawn', type=str,
                       help='Spawn mode with package name (same as -f)')
    
    parser.add_argument('--version', action='version', 
                       version='fridac 1.0 (Frida {})'.format(get_frida_version()))
    
    args = parser.parse_args()
    
    # 决定目标包和运行模式
    target_package = None
    spawn_mode = False
    force_show_apps = False
    
    if args.package:  # -f com.example.app（以 Spawn 模式启动并附加）
        target_package = args.package
        spawn_mode = True
    elif args.spawn:  # --spawn com.example.app（Spawn 模式）
        target_package = args.spawn
        spawn_mode = True
    elif args.attach_package:  # -p com.example.app（直接附加到已运行应用）
        target_package = args.attach_package
        spawn_mode = False
    elif args.apps:  # -a（显示应用列表）
        force_show_apps = True
    else:
        # 默认行为：尝试附加到前台应用
        frontmost_id, frontmost_name = get_frontmost_app()
        if frontmost_id:
            target_package = frontmost_id
            spawn_mode = False
            log_success("检测到前台应用: {} ({})".format(frontmost_name, frontmost_id))
            log_info("将自动连接到此应用，如需选择其他应用请使用 'fridac -a'")
        else:
            log_info("没有检测到前台应用，显示应用列表...")
            force_show_apps = True
    
    # 检测并显示 Python 环境信息
    env_info = detect_python_environment()
    
    # 显示 Banner 与环境信息
    show_banner()
    show_environment_info(env_info)
    
    try:
        run_frida_session(spawn_mode=spawn_mode, target_package=target_package, force_show_apps=force_show_apps)
    except KeyboardInterrupt:
        log_info("程序被用户中断")
    except Exception as e:
        log_error("运行出错: {}".format(e))
        from fridac_core.logger import is_rich_available
        if not is_rich_available():
            log_warning("建议安装 rich 获得更好的用户体验: pip install rich")

if __name__ == '__main__':
    main()
